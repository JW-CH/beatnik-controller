<div class="snapcast-container">
  <h2>Snapcast Server Status</h2>

  <ng-container *ngIf="serverDetails$ | async as serverInfo; else loadingOrError">
    <div class="server-info">
      <h3>Server Details</h3>
      <p><strong>Machine Name:</strong> {{ serverInfo.host.name || 'N/A' }}</p>
      <p><strong>Snapserver Version:</strong> {{ serverInfo.snapserver.version || 'N/A' }}</p>
      <p><strong>OS:</strong> {{ serverInfo.host.os || 'N/A' }} / {{ serverInfo.host.arch || 'N/A' }}</p>
    </div>
  </ng-container>

  <ng-container *ngIf="(streams$ | async) as streams">
    <div class="streams-info" *ngIf="streams.length > 0">
      <h3>Active Streams</h3>
      <ul>
        <li *ngFor="let stream of streams">

          ID: {{ stream.id }} | Status: {{ stream.status }} | Pause: {{ stream.properties.canPause}} | Play: {{ stream.properties.canPlay }} | Control: {{ stream.properties.canControl }}
          <br>
          <small>URI: {{ stream.uri.raw || 'N/A' }}</small>
          <div *ngIf="stream.properties.metadata as meta">
            <small>Title: {{ meta.title || 'N/A' }} - Artist: {{ meta.artist.join(', ') || 'N/A' }}</small>
          </div>
        </li>
      </ul>
    </div>
  </ng-container>

  <ng-container *ngIf="(groups$ | async) as groups">
    <div class="groups-info" *ngIf="groups.length > 0">
      <h3>Client Groups</h3>
      <div *ngFor="let group of groups" class="group-card">
        <h4>
          Group:
          <input type="text" [value]="group.name || group.id" #groupNameInput
                 (blur)="onChangeGroupName(group.id, groupNameInput.value)"
                 (keyup.enter)="onChangeGroupName(group.id, groupNameInput.value); groupNameInput.blur()"
                 placeholder="Group Name" style="margin-left: 5px; font-weight: normal; font-size: 0.9em;">
          (Stream: {{ group.stream_id }})
          <span [class.muted]="group.muted"> {{ group.muted ? '[MUTED]' : '[UNMUTED]' }} </span>
        </h4>
        <ul *ngIf="group.clients.length > 0; else noClientsInGroup">
          <li *ngFor="let client of group.clients" class="client-card">
            <strong>Client: {{ client.config.name || client.id }}</strong>
            ({{ client.host.name || 'Unknown host' }})
            <span [class.connected]="client.connected" [class.disconnected]="!client.connected">
              {{ client.connected ? '[Connected]' : '[Disconnected]' }}
            </span>
            <div class="client-controls" *ngIf="client.config.volume">
              Volume: {{ client.config.volume.percent }}%
              <span [class.muted]="client.config.volume.muted">
                {{ client.config.volume.muted ? '[MUTED]' : '[UNMUTED]' }}
              </span>
              <br>
              Set Volume:
              <input type="range" min="0" max="100" [attr.aria-label]="'Volume for ' + (client.config.name || client.id)"
                     [value]="client.config.volume.percent"
                     (change)="onSetClientVolumePercent(client.id, $event)">
              <button type="button" (click)="onToggleClientMute(client)">
                {{ client.config.volume.muted ? 'Unmute' : 'Mute' }} Client
              </button>
            </div>
          </li>
        </ul>
        <ng-template #noClientsInGroup><p>No clients in this group.</p></ng-template>
      </div>
    </div>
  </ng-container>

  <ng-template #loadingOrError>
    <p>Loading Snapcast status or WebSocket not connected...</p>
    <button type="button" (click)="snapcastService.connect()">Attempt to Connect</button>
  </ng-template>
</div>